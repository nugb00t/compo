#include "stdafx.h"

#include "profiler.h"

#include "engine.h"

using namespace engine;

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Profiler::StopWatch::StopWatch(const Section section)
: section_(section), start_(g_engine.time->msec()) {}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Profiler::StopWatch::~StopWatch() {
	g_engine.profiler->track(section_, start_, g_engine.time->msec());
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

Profiler::Profiler() {
	// avoid uninitialized section counters by placing dummy periods in the beginning
	for (unsigned section = 0; section < SECTION_COUNT; ++section)
		track((Section)section, 0, 0);
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

const Profiler::Period& Profiler::get(const Section section, const int age) const {
	assert(section < SECTION_COUNT);
	kaynine::AutoLock<> lock(guard_);
	return trackers_[section].get(age);
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Profiler::track(const Section section, const unsigned begin, const unsigned end) {
	assert(section < SECTION_COUNT);

	kaynine::AutoLock<> lock(guard_);
	trackers_[section].advance();
	trackers_[section].get() = Period(begin, end);
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
